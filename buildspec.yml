version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto17
  pre_build:
    commands:
      - wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
      - unzip -qq sonar-scanner-cli-5.0.1.3006-linux.zip
      - PATH=$PATH:/sonar-scanner-5.0.1.3006-linux/bin/
  build:
    commands:
      - echo Build started on `date`
      - mvn package --no-transfer-progress
      - ls -la
#      - mvn sonar:sonar -Dsonar.token=$SONAR_TOKEN -Dsonar.host.url=$SONAR_URL -Dsonar.projectKey=$GITHUB_ORG -Dsonar.organization=$GITHUB_ORG -Dsonar.links.scm=https://github.com/$GITHUB_ORG/$GITHUB_REPO -Dsonar.scm.provider=git --no-transfer-progress
      - mvn sonar:sonar -Dsonar.token=$SONAR_TOKEN -Dsonar.host.url=$SONAR_URL -Dsonar.projectKey=$GITHUB_ORG -Dsonar.organization=$GITHUB_ORG --no-transfer-progress
      - sleep 5
      - curl -s https://sonarcloud.io/api/qualitygates/project_status?projectKey=${GITHUB_ORG}_${GITHUB_REPO} >result.json
      - cat result.json
      - if [ $(jq -r '.projectStatus.status' result.json) = ERROR ] ; then $CODEBUILD_BUILD_SUCCEEDING -eq 0 ;fi
      - echo Build completed on `date`
  post_build:
    commands:
      - aws cloudformation package --template-file cloudformation.yml --s3-bucket jurikolo-codepipeline-bucket --output-template-file packaged-template.yaml
artifacts:
  files:
    - packaged-template.yaml
    - target/java-sample-1.0-SNAPSHOT.jar
